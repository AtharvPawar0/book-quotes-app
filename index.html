<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspiring Book Quotes</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // Removed signInWithCustomToken
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; // Optional: if you want analytics

        // Your web app's Firebase configuration - NOW WITH YOUR ACTUAL VALUES
        const firebaseConfig = {
            apiKey: "AIzaSyC4XhwTkXjYKGPfoLdb5BucR0lIaAfHRnI",
            authDomain: "ideal-quotes.firebaseapp.com",
            projectId: "ideal-quotes",
            storageBucket: "ideal-quotes.firebasestorage.app",
            messagingSenderId: "692105549685",
            appId: "1:692105549685:web:1840f1454732a62a08a53c",
            measurementId: "G-PYYL48LD6W" // Included your measurementId
        };

        // For Netlify deployment, we derive appId from firebaseConfig
        const appId = firebaseConfig.projectId; // Using Firebase projectId as a unique identifier for Firestore paths
        // initialAuthToken is not used for direct web deployment; anonymous auth is used instead.

        let app;
        let db;
        let auth;
        let currentUserId = null;
        // let analytics; // Optional: if you uncomment getAnalytics import

        // Custom message box function (replaces alert/confirm)
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} z-50`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // Initialize Firebase and authenticate user
        async function initializeFirebase() {
            try {
                // No need for config check as we're now using a hardcoded valid config
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // analytics = getAnalytics(app); // Optional: if you uncomment getAnalytics import

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('currentUserIdDisplay').textContent = `User ID: ${currentUserId}`;
                        console.log("Firebase initialized. User authenticated:", currentUserId);
                        loadUserQuotes(); // Load quotes once user is authenticated
                    } else {
                        // Sign in anonymously for persistent user data without login
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showMessage(`Firebase Init Error: ${error.message}`, "error");
            }
        }

        // Function to save a new quote to Firestore
        window.saveQuote = async function() {
            if (!currentUserId) {
                showMessage("Please wait, user not authenticated yet.", "error");
                return;
            }

            const quoteTextInput = document.getElementById('newQuoteText');
            const authorInput = document.getElementById('newQuoteAuthor');
            const bookInput = document.getElementById('newQuoteBook');

            const quoteText = quoteTextInput.value.trim();
            const author = authorInput.value.trim();
            const book = bookInput.value.trim();

            if (!quoteText || !author || !book) {
                showMessage("Please fill in all quote fields.", "error");
                return;
            }

            try {
                // Firestore path: artifacts/{appId}/users/{userId}/user_quotes
                // Using firebaseConfig.projectId as appId for consistency in external deployment
                const userQuotesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/user_quotes`);
                await addDoc(userQuotesCollectionRef, {
                    quoteText: quoteText,
                    author: author,
                    book: book,
                    timestamp: serverTimestamp() // Use server timestamp for consistent ordering
                });
                showMessage("Quote saved successfully!", "info");
                // Clear input fields
                quoteTextInput.value = '';
                authorInput.value = '';
                bookInput.value = '';
            } catch (error) {
                console.error("Error saving quote:", error);
                showMessage(`Error saving quote: ${error.message}`, "error");
            }
        };

        // Function to load and display user-submitted quotes in real-time
        function loadUserQuotes() {
            if (!db || !currentUserId) {
                console.log("Firestore not ready or user not authenticated for loading quotes.");
                return;
            }

            const userQuotesList = document.getElementById('userQuotesList');
            userQuotesList.innerHTML = '<p class="text-gray-500 dark:text-gray-300">Loading your quotes...</p>'; // Loading indicator

            // Firestore path: artifacts/{appId}/users/{userId}/user_quotes
            const userQuotesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/user_quotes`);
            const q = query(userQuotesCollectionRef, orderBy('timestamp', 'desc')); // Order by newest first

            onSnapshot(q, (snapshot) => {
                userQuotesList.innerHTML = ''; // Clear previous quotes
                if (snapshot.empty) {
                    userQuotesList.innerHTML = '<p class="text-gray-500 dark:text-gray-300">No quotes added by you yet. Add one above!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const quoteData = doc.data();
                    const quoteElement = document.createElement('div');
                    quoteElement.className = 'bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-2 shadow-sm';
                    quoteElement.innerHTML = `
                        <p class="font-semibold text-gray-800 dark:text-gray-200">"${quoteData.quoteText}"</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">-- ${quoteData.author}, <em>${quoteData.book}</em></p>
                    `;
                    userQuotesList.appendChild(quoteElement);
                });
            }, (error) => {
                console.error("Error listening to user quotes:", error);
                userQuotesList.innerHTML = `<p class="text-red-500 dark:text-red-400">Error loading your quotes: ${error.message}</p>`;
            });
        }

        // Call Firebase initialization when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>

    <style>
        /* Base styles for light mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column; /* Changed to column for multiple sections */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #334155; /* Darker text color */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            padding: 2rem; /* Added padding for overall layout */
        }
        .quote-container, .add-quote-container, .user-quotes-section {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
            padding: 2.5rem; /* More padding */
            max-width: 90%;
            width: 600px;
            text-align: center;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 2rem; /* Space between sections */
        }
        .quote-container:hover, .add-quote-container:hover {
            transform: translateY(-5px); /* Slight lift on hover */
        }
        .quote-text {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 600; /* font-semibold */
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: #1a202c; /* Even darker for quote */
            transition: color 0.3s ease;
        }
        .quote-source {
            font-size: 1.125rem; /* text-lg */
            font-style: italic;
            color: #64748b; /* Lighter gray for source */
            margin-top: 1rem;
            transition: color 0.3s ease;
        }
        .refresh-button, .save-button {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.875rem 2rem; /* py-3 px-8 */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 700; /* font-bold */
            font-size: 1.125rem; /* text-lg */
            cursor: pointer;
            border: none;
            outline: none;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .refresh-button:hover, .save-button:hover {
            background-color: #4338ca; /* Darker indigo on hover */
            transform: translateY(-2px);
        }
        .refresh-button:active, .save-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color for general body content */
        }
        body.dark-mode .quote-container, body.dark-mode .add-quote-container, body.dark-mode .user-quotes-section {
            background-color: #2d3748; /* Darker container background */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }
        /* FIX: Ensure h2 headings explicitly change color in dark mode */
        .quote-container h2,
        .add-quote-container h2,
        .user-quotes-section h2 {
            color: #1a202c; /* Default light mode color */
            transition: color 0.3s ease;
        }
        body.dark-mode .quote-container h2,
        body.dark-mode .add-quote-container h2,
        body.dark-mode .user-quotes-section h2 {
            color: #f7fafc; /* Very light color for headings in dark mode */
        }
        body.dark-mode .quote-text {
            color: #f7fafc; /* Lighter quote text */
        }
        body.dark-mode .quote-source {
            color: #a0aec0; /* Lighter source text */
        }
        body.dark-mode .refresh-button, body.dark-mode .save-button {
            background-color: #667eea; /* Lighter indigo for dark mode button */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
        }
        body.dark-mode .refresh-button:hover, body.dark-mode .save-button:hover {
            background-color: #5a67d8; /* Darker on hover */
        }
        body.dark-mode .loading-spinner {
            border-left-color: #667eea; /* Lighter spinner color */
        }

        /* Theme Toggle Button */
        .theme-toggle-button {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #cbd5e0; /* Light gray */
            color: #4a5568; /* Dark gray text */
            padding: 0.75rem 1rem;
            border-radius: 9999px; /* Fully rounded */
            font-weight: 600;
            cursor: pointer;
            border: none;
            outline: none;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .theme-toggle-button:hover {
            background-color: #a0aec0; /* Darker gray on hover */
            transform: translateY(-2px);
        }
        .theme-toggle-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        body.dark-mode .theme-toggle-button {
            background-color: #4a5568; /* Darker gray in dark mode */
            color: #e2e8f0; /* Lighter text in dark mode */
        }
        body.dark-mode .theme-toggle-button:hover {
            background-color: #2d3748; /* Even darker on hover */
        }

        /* Input fields */
        .input-field {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e0; /* Light gray border */
            background-color: #f8fafc; /* Very light background */
            color: #334155;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); /* Focus ring */
        }
        body.dark-mode .input-field {
            background-color: #4a5568; /* Darker background in dark mode */
            border-color: #64748b; /* Darker border */
            color: #e2e8f0;
        }
        body.dark-mode .input-field::placeholder {
            color: #a0aec0;
        }

        /* Message Box */
        #messageBox {
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quote-container, .add-quote-container, .user-quotes-section {
                padding: 1.5rem;
            }
            .quote-text {
                font-size: 1.5rem; /* text-2xl on smaller screens */
            }
            .quote-source {
                font-size: 1rem; /* text-base on smaller screens */
            }
            .refresh-button, .save-button {
                padding: 0.75rem 1.5rem; /* py-2 px-6 */
                font-size: 1rem; /* text-base */
            }
            .theme-toggle-button {
                top: 1rem;
                right: 1rem;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- Message Box for user feedback -->
    <div id="messageBox" class="hidden">
        <p id="messageText"></p>
    </div>

    <!-- Theme Toggle Button -->
    <button id="themeToggleButton" class="theme-toggle-button">
        <span id="themeIcon">☀️</span> <span id="themeText">Light Mode</span>
    </button>

    <!-- Section for displaying random quotes -->
    <div class="quote-container">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Random Book Quote</h2>
        <div id="loadingSpinner" class="loading-spinner"></div>
        <div id="quoteContent">
            <p id="quoteText" class="quote-text">Loading a beautiful quote...</p>
            <p id="quoteSource" class="quote-source">— Author, <em>Book Title</em></p>
        </div>
        <button id="refreshButton" class="refresh-button">Get New Quote</button>
    </div>

    <!-- Section for adding new quotes -->
    <div class="add-quote-container">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Add Your Own Quote</h2>
        <div class="flex flex-col items-center">
            <textarea id="newQuoteText" class="input-field h-32 resize-none" placeholder="Enter your quote here..."></textarea>
            <input type="text" id="newQuoteAuthor" class="input-field" placeholder="Author">
            <input type="text" id="newQuoteBook" class="input-field" placeholder="Book Title">
            <button id="saveQuoteButton" class="save-button" onclick="saveQuote()">Save Quote</button>
        </div>
    </div>

    <!-- Section for displaying user-submitted quotes -->
    <div class="user-quotes-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Your Added Quotes</h2>
        <p id="currentUserIdDisplay" class="text-sm text-gray-600 dark:text-gray-400 mb-4">User ID: Loading...</p>
        <div id="userQuotesList" class="text-left">
            <!-- FIX: Added dark:text-gray-300 to these default messages -->
            <p class="text-gray-500 dark:text-gray-300">No quotes added by you yet. Add one above!</p>
        </div>
    </div>

    <script type="module">
        // Get references to DOM elements for the random quote section
        const quoteText = document.getElementById('quoteText');
        const quoteSource = document.getElementById('quoteSource');
        const refreshButton = document.getElementById('refreshButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const quoteContent = document.getElementById('quoteContent');

        // Get references to DOM elements for the new quote section
        const newQuoteText = document.getElementById('newQuoteText');
        const newQuoteAuthor = document.getElementById('newQuoteAuthor');
        const newQuoteBook = document.getElementById('newQuoteBook');
        const saveQuoteButton = document.getElementById('saveQuoteButton');

        // Get references to DOM elements for the user quotes list
        const userQuotesList = document.getElementById('userQuotesList');
        const currentUserIdDisplay = document.getElementById('currentUserIdDisplay');

        // Theme toggle elements
        const themeToggleButton = document.getElementById('themeToggleButton');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const body = document.body;

        // Function to apply the selected theme
        function applyTheme(isDarkMode) {
            if (isDarkMode) {
                body.classList.add('dark-mode');
                themeIcon.textContent = '🌙'; // Moon icon for dark mode
                themeText.textContent = 'Dark Mode';
            } else {
                body.classList.remove('dark-mode');
                themeIcon.textContent = '☀️'; // Sun icon for light mode
                themeText.textContent = 'Light Mode';
            }
            // Store the preference in local storage
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        // Function to fetch a new quote from the backend
        async function fetchQuote() {
            // Show loading spinner and hide content
            loadingSpinner.style.display = 'block';
            quoteContent.classList.add('hidden');
            refreshButton.disabled = true; // Disable button during fetch

            try {
                // IMPORTANT: Replace 'https://my-quotes-api.onrender.com' with your deployed backend URL
                const response = await fetch('https://my-quotes-api.onrender.com/api/quote');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // Await the JSON parsing

                // Update the DOM with the new quote
                quoteText.textContent = `"${data.quote}"`;
                quoteSource.textContent = `-- ${data.author}, *${data.book}*`;

            } catch (error) {
                console.error('Failed to fetch quote:', error);
                quoteText.textContent = "Oops! Couldn't load a quote. Please try again later.";
                quoteSource.textContent = ""; // Clear source on error
            } finally {
                // Hide loading spinner and show content
                loadingSpinner.style.display = 'none';
                quoteContent.classList.remove('hidden');
                refreshButton.disabled = false; // Re-enable button
            }
        }

        // Add event listener to the refresh button
        refreshButton.addEventListener('click', fetchQuote);

        // Add event listener to the theme toggle button
        themeToggleButton.addEventListener('click', () => {
            const isDarkMode = body.classList.contains('dark-mode');
            applyTheme(!isDarkMode); // Toggle the theme
        });

        // Fetch a quote and apply saved theme when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                applyTheme(true);
            } else {
                applyTheme(false); // Default to light mode if no preference or 'light'
            }
            fetchQuote(); // Fetch the initial random quote
        });
    </script>
</body>
</html>
